<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Transport Layer Security &#8212; FoundationDB 7.1</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '7.1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Monitored Metrics" href="monitored-metrics.html" />
    <link rel="prev" title="Moving a Cluster to New Machines" href="moving-a-cluster.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          FoundationDB</a>
        <span class="navbar-text navbar-version pull-left"><b>7.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="contents.html">Site Map</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Transport Layer Security</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#setting-up-foundationdb-to-use-tls">Setting Up FoundationDB to use TLS</a><ul>
<li><a class="reference internal" href="#enabling-tls-in-a-new-cluster">Enabling TLS in a new cluster</a></li>
</ul>
</li>
<li><a class="reference internal" href="#converting-an-existing-cluster-to-use-tls-since-v6-1">Converting an existing cluster to use TLS (since v6.1)</a></li>
<li><a class="reference internal" href="#converting-an-existing-cluster-to-use-tls-v6-1">Converting an existing cluster to use TLS (&lt; v6.1)</a></li>
<li><a class="reference internal" href="#configuring-tls">Configuring TLS</a><ul>
<li><a class="reference internal" href="#default-values">Default Values</a><ul>
<li><a class="reference internal" href="#certificate-file-default-location">Certificate file default location</a></li>
<li><a class="reference internal" href="#default-peer-verification">Default Peer Verification</a></li>
<li><a class="reference internal" href="#default-password">Default Password</a></li>
</ul>
</li>
<li><a class="reference internal" href="#permissions">Permissions</a></li>
<li><a class="reference internal" href="#automatic-tls-certificate-refresh">Automatic TLS certificate refresh</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-default-libressl-based-implementation">The default LibreSSL-based implementation</a><ul>
<li><a class="reference internal" href="#formats">Formats</a></li>
<li><a class="reference internal" href="#required-files">Required files</a><ul>
<li><a class="reference internal" href="#the-certificate-file">The certificate file</a></li>
<li><a class="reference internal" href="#the-key-file">The key file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#certificate-creation">Certificate creation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#peer-verification">Peer verification</a><ul>
<li><a class="reference internal" href="#certificate-field-verification">Certificate field verification</a><ul>
<li><a class="reference internal" href="#turning-down-the-validation">Turning down the validation</a></li>
<li><a class="reference internal" href="#adding-verification-requirements">Adding verification requirements</a></li>
<li><a class="reference internal" href="#verification-examples">Verification Examples</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="moving-a-cluster.html" title="Previous Chapter: Moving a Cluster to New Machines"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Moving a Clus...</span>
    </a>
  </li>
  <li>
    <a href="monitored-metrics.html" title="Next Chapter: Monitored Metrics"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Monitored Metrics &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Transport Layer Security</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#setting-up-foundationdb-to-use-tls">Setting Up FoundationDB to use TLS</a><ul>
<li><a class="reference internal" href="#enabling-tls-in-a-new-cluster">Enabling TLS in a new cluster</a></li>
</ul>
</li>
<li><a class="reference internal" href="#converting-an-existing-cluster-to-use-tls-since-v6-1">Converting an existing cluster to use TLS (since v6.1)</a></li>
<li><a class="reference internal" href="#converting-an-existing-cluster-to-use-tls-v6-1">Converting an existing cluster to use TLS (&lt; v6.1)</a></li>
<li><a class="reference internal" href="#configuring-tls">Configuring TLS</a><ul>
<li><a class="reference internal" href="#default-values">Default Values</a><ul>
<li><a class="reference internal" href="#certificate-file-default-location">Certificate file default location</a></li>
<li><a class="reference internal" href="#default-peer-verification">Default Peer Verification</a></li>
<li><a class="reference internal" href="#default-password">Default Password</a></li>
</ul>
</li>
<li><a class="reference internal" href="#permissions">Permissions</a></li>
<li><a class="reference internal" href="#automatic-tls-certificate-refresh">Automatic TLS certificate refresh</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-default-libressl-based-implementation">The default LibreSSL-based implementation</a><ul>
<li><a class="reference internal" href="#formats">Formats</a></li>
<li><a class="reference internal" href="#required-files">Required files</a><ul>
<li><a class="reference internal" href="#the-certificate-file">The certificate file</a></li>
<li><a class="reference internal" href="#the-key-file">The key file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#certificate-creation">Certificate creation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#peer-verification">Peer verification</a><ul>
<li><a class="reference internal" href="#certificate-field-verification">Certificate field verification</a><ul>
<li><a class="reference internal" href="#turning-down-the-validation">Turning down the validation</a></li>
<li><a class="reference internal" href="#adding-verification-requirements">Adding verification requirements</a></li>
<li><a class="reference internal" href="#verification-examples">Verification Examples</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="transport-layer-security">
<h1>Transport Layer Security</h1>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>Transport Layer Security (TLS) and its predecessor, Secure Sockets Layer (SSL), are protocols designed to provide communication security over public networks. Users exchange a symmetric session key that is used to encrypt data exchanged between the parties.</p>
<p>By default, a FoundationDB cluster uses <em>unencrypted</em> connections among client and server processes. This document describes the <a class="reference external" href="http://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a> (TLS) capabilities of FoundationDB, which enable security and authentication through a public/private key infrastructure. TLS is compiled into each FoundationDB binary. This document will describe the basic TLS capabilities of FoundationDB and document its implementation, which is based on <a class="reference external" href="https://www.libressl.org/">LibreSSL</a>. TLS-enabled servers will only communicate with other TLS-enabled servers and TLS-enabled clients. Therefore, a cluster&#8217;s machines must all enable TLS in order for TLS to be used.</p>
</div>
<div class="section" id="setting-up-foundationdb-to-use-tls">
<h2>Setting Up FoundationDB to use TLS</h2>
<div class="section" id="enabling-tls-in-a-new-cluster">
<span id="enable-tls"></span><h3>Enabling TLS in a new cluster</h3>
<p>To set a new cluster to use TLS, use the <code class="docutils literal"><span class="pre">-t</span></code> flag on <code class="docutils literal"><span class="pre">make_public.py</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>user@host1$ sudo /usr/lib/foundationdb/make_public.py -t
/etc/foundationdb/fdb.cluster is now using address 10.0.1.1 (TLS enabled)
</pre></div>
</div>
<p>This will configure the new cluster to communicate with TLS.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Depending on your operating system, version and configuration, there may be a firewall in place that prevents external access to certain ports. If necessary, please consult the appropriate documentation for your OS and ensure that all machines in your cluster can reach the ports configured in your <a class="reference internal" href="configuration.html#foundationdb-conf"><span class="std std-ref">configuration file</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="converting-an-existing-cluster-to-use-tls-since-v6-1">
<span id="converting-existing-cluster-after-6-1"></span><h2>Converting an existing cluster to use TLS (since v6.1)</h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Release 6.2 removed the &#8220;connected_coordinators&#8221; field from status.</p>
</div>
<p>Since version 6.1, FoundationDB clusters can be converted to TLS without downtime. FoundationDB server can listen to TLS and unencrypted traffic simultaneously on two separate ports. As a result, FDB clusters can live migrate to TLS:</p>
<ol class="arabic">
<li><p class="first">Restart each FoundationDB server individually, but with an additional listen address for TLS traffic:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">fdbserver</span> <span class="o">-</span><span class="n">C</span> <span class="n">fdb</span><span class="o">.</span><span class="n">cluster</span> <span class="o">-</span><span class="n">p</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">4500</span> <span class="o">-</span><span class="n">p</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">4600</span><span class="p">:</span><span class="n">tls</span>
</pre></div>
</div>
<p>Since, the server still listens to unencrypted traffic and the cluster file still contains the old address, rest of the processes will be able to talk to this new process.</p>
</li>
<li><p class="first">Once all processes are listening to both TLS and unencrypted traffic, switch one or more coordinator to use TLS. Therefore, if the old coordinator list was <code class="docutils literal"><span class="pre">127.0.0.1:4500,127.0.0.1:4501,127.0.0.1:4502</span></code>, the new one would be something like <code class="docutils literal"><span class="pre">127.0.0.1:4600:tls,127.0.0.1:4501,127.0.0.1:4502</span></code>. Switching few coordinators to TLS at a time allows a smoother migration and a window to find out clients who do not yet have TLS configured. The number of coordinators each client can connect to can be seen via  <code class="docutils literal"><span class="pre">fdbstatus</span></code> (look for <code class="docutils literal"><span class="pre">connected_coordinators</span></code> field in <code class="docutils literal"><span class="pre">clients</span></code>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s2">&quot;clients&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;count&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;supported_versions&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;client_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.1.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;connected_clients&quot;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;127.0.0.1:42916&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;connected_coordinators&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s2">&quot;log_group&quot;</span> <span class="p">:</span> <span class="s2">&quot;default&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;address&quot;</span> <span class="p">:</span> <span class="s2">&quot;127.0.0.1:42918&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;connected_coordinators&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;log_group&quot;</span> <span class="p">:</span> <span class="s2">&quot;default&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span> <span class="o">...</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">If there exist a client (e.g., the client 127.0.0.1:42918 in the above example) that cannot connect to all coordinators after a coordinator is switched to TLS, it mean the client does not set up its TLS correctly. System operator should notify the client to correct the client&#8217;s TLS configuration. Otherwise, when all coordinators are switched to TLS ports, the client will loose connection.</p>
</li>
<li><p class="first">Repeat (2) and (3) until all the addresses in coordinator list are TLS.</p>
</li>
<li><p class="first">Restart each FoundationDB server, but only with one public address that listens to TLS traffic only.</p>
</li>
</ol>
</div>
<div class="section" id="converting-an-existing-cluster-to-use-tls-v6-1">
<span id="converting-existing-cluster-before-6-1"></span><h2>Converting an existing cluster to use TLS (&lt; v6.1)</h2>
<p>Enabling TLS on an existing (non-TLS) cluster cannot be accomplished without downtime because all processes must have TLS enabled to communicate. At startup, each server process enables TLS if the addresses in its cluster file are TLS-enabled. As a result, server processes must be stopped and restarted to convert them to use TLS. To convert the cluster to TLS in the most conservative way:</p>
<ol class="arabic simple">
<li>Stop all FoundationDB clients and <a class="reference internal" href="administration.html#administration-running-foundationdb"><span class="std std-ref">server processes</span></a> in the cluster.</li>
<li>Change all cluster files to have the <code class="docutils literal"><span class="pre">:tls</span></code> suffix for each coordinator.</li>
<li>Restart the cluster and the clients.</li>
</ol>
</div>
<div class="section" id="configuring-tls">
<span id="id2"></span><h2>Configuring TLS</h2>
<p>The operation of TLS is configured through five settings. These settings can be provided as command-line options, client options, or environment variables, and are named as follows:</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="16%" />
<col width="23%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command-line Option</th>
<th class="head">Client Option</th>
<th class="head">Environment Variable</th>
<th class="head">Purpose</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">tls_certificate_file</span></code></td>
<td><code class="docutils literal"><span class="pre">TLS_cert_path</span></code></td>
<td><code class="docutils literal"><span class="pre">FDB_TLS_CERTIFICATE_FILE</span></code></td>
<td>Path to the file from which the local certificates
can be loaded</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">tls_key_file</span></code></td>
<td><code class="docutils literal"><span class="pre">TLS_key_path</span></code></td>
<td><code class="docutils literal"><span class="pre">FDB_TLS_KEY_FILE</span></code></td>
<td>Path to the file from which to load the private
key</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">tls_verify_peers</span></code></td>
<td><code class="docutils literal"><span class="pre">TLS_verify_peers</span></code></td>
<td><code class="docutils literal"><span class="pre">FDB_TLS_VERIFY_PEERS</span></code></td>
<td>The byte-string for the verification of peer
certificates and sessions</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">tls_password</span></code></td>
<td><code class="docutils literal"><span class="pre">TLS_password</span></code></td>
<td><code class="docutils literal"><span class="pre">FDB_TLS_PASSWORD</span></code></td>
<td>The byte-string representing the passcode for
unencrypting the private key</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">tls_ca_file</span></code></td>
<td><code class="docutils literal"><span class="pre">TLS_ca_path</span></code></td>
<td><code class="docutils literal"><span class="pre">FDB_TLS_CA_FILE</span></code></td>
<td>Path to the file containing the CA certificates
to trust</td>
</tr>
</tbody>
</table>
<p>The value for each setting can be specified in more than one way.  The actual valued used is determined in the following order:</p>
<ol class="arabic simple">
<li>An explicitly specified value as a command-line option or client option, if one is given;</li>
<li>The value of the environment variable, if one has been set;</li>
<li>The default value</li>
</ol>
<p>For the password, rather than using the command-line option, it is recommended to use the environment variable <code class="docutils literal"><span class="pre">FDB_TLS_PASSWORD</span></code>, as command-line options are more visible to other processes running on the same host.</p>
<p>As with all other command-line options to <code class="docutils literal"><span class="pre">fdbserver</span></code>, the TLS settings can be specified in the <a class="reference internal" href="configuration.html#foundationdb-conf-fdbserver"><span class="std std-ref">[fdbserver] section of the configuration file</span></a>.</p>
<p>The settings for certificate file, key file, peer verification, password and CA file are interpreted by the software.</p>
<div class="section" id="default-values">
<h3>Default Values</h3>
<div class="section" id="certificate-file-default-location">
<h4>Certificate file default location</h4>
<p>The default behavior when the certificate or key file is not specified is to look for a file named <code class="docutils literal"><span class="pre">fdb.pem</span></code> in the current working directory. If this file is not present, an attempt is made to load a file from a system-dependent location as follows:</p>
<ul class="simple">
<li>Linux: <code class="docutils literal"><span class="pre">/etc/foundationdb/fdb.pem</span></code></li>
<li>macOS: <code class="docutils literal"><span class="pre">/usr/local/etc/foundationdb/fdb.pem</span></code></li>
<li>Windows: <code class="docutils literal"><span class="pre">C:\ProgramData\foundationdb\fdb.pem</span></code></li>
</ul>
</div>
<div class="section" id="default-peer-verification">
<h4>Default Peer Verification</h4>
<p>The default peer verification is <code class="docutils literal"><span class="pre">Check.Valid=1</span></code>.</p>
</div>
<div class="section" id="default-password">
<h4>Default Password</h4>
<p>There is no default password. If no password is specified, it is assumed that the private key is unencrypted.</p>
</div>
</div>
<div class="section" id="permissions">
<h3>Permissions</h3>
<p>All files used by TLS must have sufficient read permissions such that the user running the FoundationDB server or client process can access them. It may also be necessary to have similar read permissions on the parent directories of the files used in the TLS configuration.</p>
</div>
<div class="section" id="automatic-tls-certificate-refresh">
<h3>Automatic TLS certificate refresh</h3>
<p>The TLS certificate will be automatically refreshed on a configurable cadence. The server will inspect the CA, certificate, and key files in the specified locations periodically, and will begin using the new versions if following criterion were met:</p>
<ul class="simple">
<li>They are changed, judging by the last modified time.</li>
<li>They are valid certificates.</li>
<li>The key file matches the certificate file.</li>
</ul>
<p>The refresh rate is controlled by <code class="docutils literal"><span class="pre">--knob-tls-cert-refresh-delay-seconds</span></code>. Setting it to 0 will disable the refresh.</p>
</div>
</div>
<div class="section" id="the-default-libressl-based-implementation">
<h2>The default LibreSSL-based implementation</h2>
<p>FoundationDB offers TLS based on the LibreSSL library. By default, it will be enabled automatically when participating in a TLS-enabled cluster.</p>
<p>For TLS to operate, each process (both server and client) must have an X509 certificate, its corresponding private key, and the certificates with which it was signed. When a process begins to communicate with a FoundationDB server process, the peer&#8217;s certificate is checked to see if it is trusted and the fields of the peer certificate are verified. Peers must share the same root trusted certificate, and they must both present certificates whose signing chain includes this root certificate.</p>
<p>If the local certificate and chain is invalid, a FoundationDB server process bound to a TLS address will not start. In the case of invalid certificates on a client, the client will be able to start but will be unable to connect any TLS-enabled cluster.</p>
<div class="section" id="formats">
<h3>Formats</h3>
<p>LibreSSL can read certificates and their private keys in base64-encoded DER-formatted X.509 format (which is known as PEM). A PEM file can contain both certificates and a private key or the two can be stored in separate files.</p>
</div>
<div class="section" id="required-files">
<h3>Required files</h3>
<p>A single file can contain the information as described in both of the following sections.</p>
<div class="section" id="the-certificate-file">
<span id="tls-certificate-file"></span><h4>The certificate file</h4>
<p>A file must be supplied that contains an ordered list of certificates. The first certificate is the process&#8217; own certificate. Each following certificate must sign the one preceding it.</p>
<p>All but the last certificate are provided to peers during TLS handshake as the certificate chain.</p>
<p>The last certificate in the list is the trusted certificate.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the certificate list contains only one certificate, that certificate <em>must</em> be self-signed and will be used as both the certificate chain and the trusted certificate.</p>
</div>
<p>Each of these certificates must be in the form:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">--------</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">--------</span>
<span class="n">xxxxxxxxxxxxxxx</span>
<span class="o">--------</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">--------</span>
</pre></div>
</div>
</div>
<div class="section" id="the-key-file">
<span id="tls-key-file"></span><h4>The key file</h4>
<p>The key file must contain the private key corresponding to the process&#8217; own certificate. The private key must be in PKCS#8 format, which means that it must be surrounded by:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-----</span><span class="n">BEGIN</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">xxxxxxxxxxxxxxx</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
</pre></div>
</div>
<p>It can optionally be encrypted by the password provided to tls_password.</p>
</div>
</div>
<div class="section" id="certificate-creation">
<h3>Certificate creation</h3>
<p>If your organization already makes use of certificates for access control and securing communications, you should ask your security expert for organizational procedure for obtaining and verifying certificates. If the goal of enabling TLS is to make sure that only known machines can join or access the FoundationDB cluster and for securing communications, then creating your own certificates can serve these purposes.</p>
<p>The following set of commands uses the OpenSSL command-line tools to create a self-signed certificate and private key. The certificate is then joined with the private key in the output <code class="docutils literal"><span class="pre">fdb.pem</span></code> file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">user</span><span class="nd">@host</span><span class="p">:</span><span class="o">&gt;</span> <span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">x509</span> <span class="o">-</span><span class="n">nodes</span> <span class="o">-</span><span class="n">days</span> <span class="mi">365</span> <span class="o">-</span><span class="n">newkey</span> <span class="n">rsa</span><span class="p">:</span><span class="mi">2048</span> <span class="o">-</span><span class="n">keyout</span> <span class="n">private</span><span class="o">.</span><span class="n">key</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">crt</span>
<span class="n">user</span><span class="nd">@host</span><span class="p">:</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="n">cert</span><span class="o">.</span><span class="n">crt</span> <span class="n">private</span><span class="o">.</span><span class="n">key</span> <span class="o">&gt;</span> <span class="n">fdb</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="peer-verification">
<h2>Peer verification</h2>
<p>A FoundationDB server or client will only communicate with peers that present a certificate chain that meets the verification requirements. By default, the only requirement is that the provided certificate chain ends in a certificate signed by the local trusted certificate.</p>
<div class="section" id="certificate-field-verification">
<span id="tls-verify-peers"></span><h3>Certificate field verification</h3>
<p>With a peer verification string, FoundationDB servers and clients can adjust what is required of the certificate chain presented by a peer. These options can make the certificate requirements more rigorous or more lenient. You can specify multiple verification strings by providing additional tls_verify_peers command line arguments or concatenating them with <code class="docutils literal"><span class="pre">|</span></code>. All <code class="docutils literal"><span class="pre">,</span></code> or <code class="docutils literal"><span class="pre">|</span></code> in the verify peers fields should be escaped with <code class="docutils literal"><span class="pre">\</span></code>.</p>
<div class="section" id="turning-down-the-validation">
<h4>Turning down the validation</h4>
<p>If the default checking of the certificate chain is too stringent, the verification string can contain settings to weaken what certificates are accepted.</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Result</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">Check.Valid=0</span></code></td>
<td>Sets the current process to disable all further verification
of a peer certificate.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">Check.Unexpired=0</span></code></td>
<td>Disables date checking of peer certificates. If the clocks in
the cluster and between the clients and servers are not to be
trusted, setting this value to <code class="docutils literal"><span class="pre">0</span></code> can allow communications
to proceed.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="adding-verification-requirements">
<h4>Adding verification requirements</h4>
<p>Requirements can be placed on the fields of the Issuer and Subject DNs in the peer&#8217;s own certificate. These requirements take the form of a comma-separated list of conditions. Each condition takes the form of <code class="docutils literal"><span class="pre">field[&lt;&gt;]?=value</span></code>. Only certain fields from a DN can be matched against.</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="73%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Well known name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">CN</span></code></td>
<td>Common Name</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">C</span></code></td>
<td>Country</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">L</span></code></td>
<td>Locality</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ST</span></code></td>
<td>State</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">O</span></code></td>
<td>Organization</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">OU</span></code></td>
<td>Organizational Unit</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">UID</span></code></td>
<td>Unique Identifier</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">DC</span></code></td>
<td>Domain Component</td>
</tr>
</tbody>
</table>
<p>The field of each condition may optionally have a DN prefix, which is otherwise considered to be for the Subject DN.</p>
<table border="1" class="docutils">
<colgroup>
<col width="78%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Prefix</th>
<th class="head">DN</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">S.</span></code>, <code class="docutils literal"><span class="pre">Subject.</span></code>, or none</td>
<td>Subject</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">I.</span></code>, or <code class="docutils literal"><span class="pre">Issuer.</span></code></td>
<td>Issuer</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">R.</span></code>, or <code class="docutils literal"><span class="pre">Root.</span></code></td>
<td>Root</td>
</tr>
</tbody>
</table>
<p>Additionally, the verification can be restricted to certificates signed by a given root CA with the field <code class="docutils literal"><span class="pre">Root.CN</span></code>. This allows you to have different requirements for different root chains.</p>
<p>The value of a condition must be specified in a form derived from a subset of <a class="reference external" href="http://www.ietf.org/rfc/rfc4514.txt">RFC 4514</a>. Specifically, the &#8220;raw&#8221; notation (a value starting with the <code class="docutils literal"><span class="pre">#</span></code> character) is not accepted. Other escaping mechanisms, including specifying characters by hex notation, are allowed. The specified field&#8217;s value must exactly match the value in the peer&#8217;s certificate.</p>
<p>By default, the fields of a peer certificate&#8217;s DNs are not examined.</p>
<p>In addition to DNs, restrictions can be placed against X509 extensions. They are specified in the same fashion as DN requirements.  The supported extensions are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Well known name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">subjectAltName</span></code></td>
<td>Subject Alternative Name</td>
</tr>
</tbody>
</table>
<p>Within a subject alternative name requirement, the value specified is required to have the form <code class="docutils literal"><span class="pre">prefix:value</span></code>, where the prefix specifies the type of value being matched against.  The following prefixes are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Prefix</th>
<th class="head">Well known name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>DNS</td>
<td>Domain Name</td>
</tr>
<tr class="row-odd"><td>URI</td>
<td>Uniform Resource Identifier</td>
</tr>
<tr class="row-even"><td>IP</td>
<td>IP Address</td>
</tr>
<tr class="row-odd"><td>EMAIL</td>
<td>Email Address</td>
</tr>
</tbody>
</table>
<p>The following operators are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operator</th>
<th class="head">Match Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">=</span></code></td>
<td>Exact Match</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">&gt;=</span></code></td>
<td>Prefix Match</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">&lt;=</span></code></td>
<td>Suffix Match</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="verification-examples">
<h4>Verification Examples</h4>
<p>Let&#8217;s consider a certificate, whose abridged contents is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Certificate</span><span class="p">:</span>
    <span class="n">Data</span><span class="p">:</span>
        <span class="n">Version</span><span class="p">:</span> <span class="mi">3</span> <span class="p">(</span><span class="mh">0x2</span><span class="p">)</span>
        <span class="n">Serial</span> <span class="n">Number</span><span class="p">:</span> <span class="mi">12938646789571341173</span> <span class="p">(</span><span class="mh">0xb38f4eb406a5eb75</span><span class="p">)</span>
    <span class="n">Signature</span> <span class="n">Algorithm</span><span class="p">:</span> <span class="n">sha1WithRSAEncryption</span>
        <span class="n">Issuer</span><span class="p">:</span> <span class="n">C</span><span class="o">=</span><span class="n">US</span><span class="p">,</span> <span class="n">ST</span><span class="o">=</span><span class="n">California</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">Cupertino</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="n">FDB</span> <span class="n">Team</span>
        <span class="n">Subject</span><span class="p">:</span> <span class="n">C</span><span class="o">=</span><span class="n">US</span><span class="p">,</span> <span class="n">ST</span><span class="o">=</span><span class="n">California</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">Cupertino</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span><span class="p">,</span> <span class="n">OU</span><span class="o">=</span><span class="n">FDB</span> <span class="n">Team</span>
        <span class="n">X509v3</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="n">X509v3</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span>
                <span class="n">DNS</span><span class="p">:</span><span class="n">test</span><span class="o">.</span><span class="n">foundationdb</span><span class="o">.</span><span class="n">org</span>
                <span class="n">DNS</span><span class="p">:</span><span class="n">prod</span><span class="o">.</span><span class="n">foundationdb</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>A verification string of:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Check</span><span class="o">.</span><span class="n">Unexpired</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">I</span><span class="o">.</span><span class="n">C</span><span class="o">=</span><span class="n">US</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">US</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">O</span><span class="o">=</span><span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span>
</pre></div>
</div>
<p>Would pass, and:</p>
<ul class="simple">
<li>Skip the check on all peer certificates that the certificate is not yet expired</li>
<li>Require that the Issuer has a Country field of <code class="docutils literal"><span class="pre">US</span></code></li>
<li>Require that the Subject has a Country field of <code class="docutils literal"><span class="pre">US</span></code></li>
<li>Require that the Subject has a Organization field of <code class="docutils literal"><span class="pre">Apple</span> <span class="pre">Inc.</span></code></li>
</ul>
<p>A verification string of:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">S</span><span class="o">.</span><span class="n">OU</span><span class="o">&gt;=</span><span class="n">FDB</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">OU</span><span class="o">&lt;=</span><span class="n">Team</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">subjectAltName</span><span class="o">=</span><span class="n">DNS</span><span class="p">:</span><span class="n">test</span><span class="o">.</span><span class="n">foundationdb</span><span class="o">.</span><span class="n">org</span>
</pre></div>
</div>
<p>Would pass, and:</p>
<ul class="simple">
<li>Require that the Subject has an Organization field that starts with <code class="docutils literal"><span class="pre">FDB</span></code></li>
<li>Require that the Subject has an Organization field that ends with <code class="docutils literal"><span class="pre">Team</span></code></li>
<li>Require that the Subject has a Subject Alternative Name extension, which has one or more members of type DNS with a value of <code class="docutils literal"><span class="pre">test.foundationdb.org</span></code>.</li>
</ul>
<p>A verification string of:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">S</span><span class="o">.</span><span class="n">subjectAltName</span><span class="o">&gt;=</span><span class="n">DNS</span><span class="p">:</span><span class="n">prod</span><span class="o">.</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">subjectAltName</span><span class="o">&lt;=</span><span class="n">DNS</span><span class="p">:</span><span class="o">.</span><span class="n">org</span>
</pre></div>
</div>
<p>Would pass, and:</p>
<ul class="simple">
<li>Require that the Subject has a Subject Alternative Name extension, which has one or more members of type DNS that begins with the value <code class="docutils literal"><span class="pre">prod.</span></code>.</li>
<li>Require that the Subject has a Subject Alternative Name extension, which has one or more members of type DNS that ends with the value <code class="docutils literal"><span class="pre">.org</span></code>.</li>
</ul>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/tls.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013-2021 Apple, Inc and the FoundationDB project authors.<br/>
      Last updated on Apr 28, 2022.<br/>
    </p>
  </div>
</footer>
  </body>
</html>